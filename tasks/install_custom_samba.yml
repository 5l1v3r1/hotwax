---
# From: https://forums.offensive-security.com/showthread.php?12943-Found-solution-to-enum4linux-rpcclient-problem-NT_STATUS_INVALID_PARAMETER&p=73263
#
# It seems that the more recent smbclient/rpcclient tools enforce usage of 
#  security signatures during SMB session negotiation. I compared the traffic
#  from rpcclient with the one generated from nmap smb enumeration scripts.
# The nmap enumeration scripts worked, i.e. were able to setup a session. 
# I saw that rpcclient sets the 'Security Signatures Required' flag whereas 
#  nmap does not. If you have an idea why this might prevent session setup, 
# I would be happy about a message.
# Anyway, you can fix this by downloading and compiling an older version of samba:
# https://github.com/samba-team/samba/archive/samba-4.5.16.tar.gz

- name: Install prerequisites
  command: apt install -y acl apt-utils attr autoconf bind9utils binutils bison build-essential curl debhelper dnsutils docbook-xml docbook-xsl flex gcc gdb git glusterfs-common gzip heimdal-clients heimdal-dev heimdal-kcm heimdal-multidev hostname htop krb5-config lcov libacl1-dev libaio-dev libarchive-dev libattr1-dev libavahi-client-dev libavahi-common-dev libblkid-dev libbsd-dev libcap-dev libcups2-dev libdbus-1-dev libfam-dev libgcrypt20-dev libglib2.0-dev libglusterfs-dev libgnutls28-dev libgpgme-dev libgssapi3-heimdal libicu-dev libjansson-dev libjs-jquery libjson-perl libkadm5clnt7-heimdal libkadm5srv8-heimdal libkafs0-heimdal libkdc2-heimdal libkrb5-26-heimdal libldap2-dev liblmdb-dev liblttng-ust-dev libmd-dev libmhash-dev libncurses5-dev libotp0-heimdal libpam0g-dev libparse-yapp-perl libpcap-dev libpopt-dev libreadline-gplv2-dev libsl0-heimdal libssl1.0-dev libsystemd-dev libtasn1-6-dev libtasn1-bin libunwind-dev lmdb-utils locales lsb-release make mawk mingw-w64 nettle-dev patch perl perl-modules-5.28 pkg-config procps psmisc python-crypto python-dbg python-dev python-dnspython python-gpg python-iso8601 python-markdown python-pexpect python3 python3-crypto python3-dbg python3-dev python3-dnspython python3-gpg python3-iso8601 python3-markdown python3-matplotlib python3-pexpect rsync sed sudo tar tree uuid-dev xfslibs-dev xsltproc zlib1g-dev libtdb-dev libtalloc-dev python-talloc-dev python3-talloc-dev libtevent-dev

- name: Download samba
  get_url:
    url: https://github.com/samba-team/samba/archive/samba-4.5.16.tar.gz
    validate_certs: no
    dest: /root/Downloads/samba-4.5.16.tar.gz
    mode: 333
    owner: root
  register: samba_download

- name: Remove old samba build
  command: rm -rf samba-4.5.16
  args:
    chdir: /root/Downloads
    removes: /root/Downloads/samba-4.5.16/
  when: samba_download.changed

- name: Extract Samba 4.5.16.tar.gz
  command: tar xzvf samba-4.5.16.tar.gz
  args:
    chdir: /root/Downloads
    creates: /root/Downloads/samba-4.5.16/
  when: samba_download.changed

- name: Move Samba 4.5.16.tar.gz
  command: mv samba-samba-4.5.16 samba-4.5.16
  args:
    chdir: /root/Downloads
    creates: /root/Downloads/samba-4.5.16/
  when: samba_download.changed

- name: Download patch for Samba 4.5.16.tar.gz
  get_url: 
    url: https://raw.githubusercontent.com/BrashEndeavours/samba/master/samba-4.5.16.patch
    validate_certs: no
    dest: /root/Downloads/samba-4.5.16/
    mode: 333
    owner: root
  when: samba_download.changed

- name: Apply patch for Samba 4.5.16
  command: patch source3/client/client.c samba-4.5.16.patch
  args:
    chdir: /root/Downloads/samba-4.5.16/
  when: samba_download.changed

- name: Configure Samba 4.5.16
  command: ./configure --prefix=/usr/local --exec-prefix=/usr/local --sysconfdir=/etc --enable-fhs --localstatedir=/var --with-piddir=/run/samba --enable-selftest
  args:
    chdir: /root/Downloads/samba-4.5.16/
  when: samba_download.changed

- name: Make Samba 4.5.15
  command: make
  args:
    chdir: /root/Downloads/samba-4.5.16/
  register: samba_make_result
  success_when: 'finished successfully' in samba_make_result.stdout
  when: samba_download.changed

- name: Install Samba 4.5.16
  command: make install
  args:
    chdir: /root/Downloads/samba-4.5.16/
  register: samba_install_result
  success_when: 'finished successfully' in samba_install_result.stdout
  when: samba_download.changed
